## Оптимизация функции ТК_ПолучитьИсходныеДанныеАктированияПоФилиалу 

Располагается в общем модуле "ТК_Актирование"

```
Функция ТК_ПолучитьИсходныеДанныеАктированияПоФилиалу(ДанныеКонтекста = Неопределено, Организация, ТекущаяДата = Неопределено) Экспорт
	
	ОбщийМенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	ИсходныеДанные = ТК_ПолучитьСтруктуруИсходныхДанных(ОбщийМенеджерВременныхТаблиц);
	
	Если НЕ ЗначениеЗаполнено(ТекущаяДата) Тогда
		ТекущаяДата = ТекущаяДатаСеанса();
	КонецЕсли;
	
	ИсходныеДанные.ТекущаяДата = ТекущаяДата;
	
	// ДелоТех 20.12.2023 Иванов Р.А. #ДО-23-009655. Оптимизировать процесс актирования в части работы с кодами ИРС
	// Этот запрос выполняется вечность
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ОбщийМенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ИВД.Договор КАК Договор
	|ПОМЕСТИТЬ ВТ_ДоговораИсключения
	|ИЗ
	|	РегистрСведений.ТК_АктированиеИсторияВыполненияЭтапов КАК ИВЭ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ИсторияВыполненияАктированияПоДоговорам КАК ИВД
	|		ПО ИВЭ.ИденитификаторЗапуска = ИВД.ИденитификаторЗапуска
	|ГДЕ
	|	ИВЭ.ДатаАктирования = &ТекущаяДата
	|	И ИВЭ.Организация = &Организация
	|	И ИВД.Ошибка = ЛОЖЬ
	|	И ИВД.ДатаОкончания <> ДАТАВРЕМЯ(1, 1, 1)
	|	И &ЭтоРучнойЗапуск = Ложь
	|;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |//Семен + Собираем заказы с договорами в отдельную ВТ_ДоговораЗаказов 
    |ВЫБРАТЬ
    |	ЗК.Договор КАК Договор,
    |	ЗК.Проведен КАК Проведен,
    |	ЗК.Ссылка КАК Ссылка,
    |	ЗК.ТК_МаршрутКругорейса КАК ТК_МаршрутКругорейса,
	|   ЗК.ТК_Кругорейс КАК ТК_Кругорейс,
	|   ЗК.ТК_ДоходныйПолурейс КАК ТК_ДоходныйПолурейс,
	|   ЗК.ТК_БазовоеТранспортноеРешение
    |ПОМЕСТИТЬ ВТ_ДоговораЗаказов
    |ИЗ
    |	Документ.ЗаказКлиента КАК ЗК
    |ГДЕ
    |	ЗК.Организация = &Организация
    |
    |ИНДЕКСИРОВАТЬ ПО
    |	ЗК.Договор,
    |	ЗК.Проведен,
    |	ЗК.Ссылка
    |;   
	|
	|////////////////////////////////////////////////////////////////////////////////
    |//Семен - 	
    |ВЫБРАТЬ
	|	договора.Организация КАК Организация,
	|	МИНИМУМ(ЕСТЬNULL(РПД.Период, договора.ДатаНачалаДействия)) КАК НачальныйПериод,
	|	договора.Ссылка КАК Договор,
	|	договора.ТК_ГлубинаКорректировок КАК ТК_ГлубинаКорректировок,
	|	договора.ТК_РасчетныйПериод КАК РасчетныйПериодВДоговоре
	|ПОМЕСТИТЬ ВТ_ПериодыДоговора_Пред
	|ИЗ
	|	Справочник.ДоговорыКонтрагентов КАК договора
	|//Семен + Убираем условие с подзапросом и заменем на соединение в ВТ_ДоговораЗаказов
    |	    ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ДоговораЗаказов КАК ВТ_ДоговораЗаказов
	|	    ПО договора.Ссылка = ВТ_ДоговораЗаказов.Договор
	|	    И ВТ_ДоговораЗаказов.Проведен
	|//Семен -
    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_РасчетныеПериодыДоговоров КАК РПД
	|		ПО (РПД.Договор = договора.Ссылка)
	|			И (РПД.Период <= ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ОграничениеОтбораКонтрагентовИДоговоров КАК ООКД
	|		ПО (ООКД.ДоговорКонтрагента = договора.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДоговораИсключения КАК ДИ
	|		ПО (ДИ.Договор = договора.Ссылка)
	|ГДЕ
	|	договора.Организация = &Организация
	|	И ДИ.Договор ЕСТЬ NULL
	|	И ЕСТЬNULL(&Договор, договора.Ссылка) = договора.Ссылка
	|	И договора.ПометкаУдаления = ЛОЖЬ
	|	И ООКД.ДоговорКонтрагента ЕСТЬ NULL
    |//Семен + 	Убираем условие с подзапросом и заменем на соединение в ВТ_ДоговораЗаказов
 	|//	И договора.Ссылка В
	|//			(ВЫБРАТЬ
	|//				ЗК.Договор
	|//			ИЗ
	|//				Документ.ЗаказКлиента КАК ЗК
	|//			ГДЕ
	|//				ЗК.Проведен = ИСТИНА)
    |//Семен - 	
	|	И договора.ТК_ДоговорДляПорожнихПеревозок = ЛОЖЬ
	|
	|СГРУППИРОВАТЬ ПО
	|	договора.Организация,
	|	договора.Ссылка,
	|	договора.ТК_ГлубинаКорректировок,
	|	договора.ТК_РасчетныйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	договора.Организация КАК Организация,
	|	договора.Договор КАК Договор,
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	//|	ВЫБОР
	//|		КОГДА ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода > ЕСТЬNULL(РПД.Период, ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода)
	//|			ТОГДА ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода
	//|		ИНАЧЕ ЕСТЬNULL(РПД.Период, ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода)
	//|	КОНЕЦ КАК ДатаНачалаПериода,
	//|	ЕСТЬNULL(МИНИМУМ(ДОБАВИТЬКДАТЕ(CРПД.Период, ДЕНЬ, -1)), ДАТАВРЕМЯ(2999, 1, 1)) КАК ДатаОкончанияПериода,
	//|	ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод КАК РасчетныйПериод
	|	ЕСТЬNULL(РПД.Период, договора.НачальныйПериод) КАК ДатаНачалаПериода,
	|	ЕСТЬNULL(МИНИМУМ(ДОБАВИТЬКДАТЕ(CРПД.Период, ДЕНЬ, -1)), ДАТАВРЕМЯ(2999, 1, 1)) КАК ДатаОкончанияПериода,
	|	ЕСТЬNULL(РПД.РасчетныйПериод, договора.РасчетныйПериодВДоговоре) КАК РасчетныйПериод,
	|	ВЫБОР
	|		КОГДА РПД.Период > ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	|			ТОГДА РПД.Период
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	|	КОНЕЦ КАК МинимальноДопустимаяДатаОкончанияПериода
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|ПОМЕСТИТЬ ВТ_ПериодыДоговора
	|ИЗ
	|	ВТ_ПериодыДоговора_Пред КАК договора
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_РасчетныеПериодыДоговоров КАК РПД
	|		ПО (РПД.Договор = договора.Договор)
	|			И (РПД.Период >= договора.НачальныйПериод)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_РасчетныеПериодыДоговоров КАК CРПД
	|		ПО (CРПД.Договор = договора.Договор)
	|			И (CРПД.Период > РПД.Период)
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	//|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_ПериодыЗакрытия.СписокОрганизаций КАК ТК_ПериодыЗакрытия
	//|		ПО (ЕСТЬNULL(РПД.РасчетныйПериод, договора.РасчетныйПериодВДоговоре) = ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод)
	//|			И (ВЫБОР
	//|				КОГДА РПД.Период > ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	//|					ТОГДА РПД.Период
	//|				ИНАЧЕ ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	//|			КОНЕЦ МЕЖДУ ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода И ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода)
	//|			И (ТК_ПериодыЗакрытия.Организация = договора.Организация)
	//|			И (ТК_ПериодыЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|
	|СГРУППИРОВАТЬ ПО
	|	договора.Организация,
	|	договора.Договор,
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	//|	РПД.Период,
	//|	ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода,
	//|	ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод
	|	ЕСТЬNULL(РПД.Период, договора.НачальныйПериод),
	|	ЕСТЬNULL(РПД.РасчетныйПериод, договора.РасчетныйПериодВДоговоре),
	|	ВЫБОР
	|		КОГДА РПД.Период > ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	|			ТОГДА РПД.Период
	|		ИНАЧЕ ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -договора.ТК_ГлубинаКорректировок)
	|	КОНЕЦ
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Договор,
	|	РасчетныйПериод,
	|	ДатаНачалаПериода,
	|	ДатаОкончанияПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГПУ.Организация КАК Организация,
	|	ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода КАК ДатаНачалаПериода,
	|	ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода КАК ДатаОкончанияПериода,
	|	ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод КАК РасчетныйПериод,
	|	ДанныеРПА.ПериодЗакрытия КАК ПериодЗакрытия,
    |//Семен + 	ДанныеРПА.Документ имеет составной тип
	|//	ДанныеРПА.Документ.Договор КАК Договор,
	|	ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).Договор КАК Договор,
    |//Семен -
	|	ГрафикЗакрытия.ДатаНачалаЭтапа > &ТекущаяДата КАК ЭтоПрогнозныйПериод,
	// 24.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-366
	|	ПД.ДатаНачалаПериода КАК ДатаНачалаПериодаДоговора,
	// 24.11.2022 *** Gradum *** ЛеушинДК (конец)
    |//Семен + 
	|//	ДанныеРПА.Документ КАК Документ,
	|	ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг) КАК Документ,
    |//Семен - 
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|	ПД.Договор ЕСТЬ НЕ NULL  КАК ВерныйПериод
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|ПОМЕСТИТЬ ВТ_ОрганизацияДоговорыПериоды_Пред
	|ИЗ
	|	РегистрСведений.ТК_АктированиеГлубинаПоискаУДФ КАК ГПУ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ДанныеРасчетногоПериодаАктов КАК ДанныеРПА
    |//Семен + 	Условие соединения по ССЫЛКА не уменьшит количество прицепляемых таблиц + ДанныеРПА.Документ меняем на ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг)
	|//		ПО (ДанныеРПА.Документ ССЫЛКА Документ.РеализацияТоваровУслуг)
 	|		ПО 
	|//			И (ДанныеРПА.Документ.Дата >= ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -ГПУ.ГлубинаПоиска))
 	|//			И ГПУ.Организация = ДанныеРПА.Документ.Организация
	|//			И (ДанныеРПА.Документ.Дата >= ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -ДанныеРПА.Документ.ТК_ГлубинаКорректировок))
	|			(ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).Дата >= ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -ГПУ.ГлубинаПоиска))
 	|			И ГПУ.Организация = ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).Организация
	|			И (ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).Дата >= ДОБАВИТЬКДАТЕ(&ТекущаяДата, ДЕНЬ, -ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).ТК_ГлубинаКорректировок))
   |//Семен -
	|			И (ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).ТК_Штраф = ЛОЖЬ)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РТУ
	|		ПО ((ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг)) = РТУ.Ссылка)
	|			И (РТУ.Проведен = ИСТИНА)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_ПериодыЗакрытия.СписокОрганизаций КАК ТК_ПериодыЗакрытия
	|		ПО (ДанныеРПА.ПериодЗакрытия = ТК_ПериодыЗакрытия.Ссылка)
	|//Семен + 
    |//			И (ТК_ПериодыЗакрытия.Организация = ДанныеРПА.Документ.Договор.Организация)
    |			И (ТК_ПериодыЗакрытия.Организация = ВЫРАЗИТЬ(ДанныеРПА.Документ КАК Документ.РеализацияТоваровУслуг).Договор.Организация)
	|//Семен - 
    |			И (ДанныеРПА.РасчетныйПериод = ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод)
	|			И (ДанныеРПА.ПериодЗакрытия.ДатаНачалаПериода МЕЖДУ ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода И ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода)
	|			И (ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода <= &ТекущаяДата)
	|			И (ТК_ПериодыЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_НастройкаГрафикаЗакрытияРасчетногоПериодаНаКалендарныйГод.ГрафикЗакрытия КАК ГрафикЗакрытия
	|		ПО (ТК_ПериодыЗакрытия.Ссылка = ГрафикЗакрытия.ПериодЗакрытия)
	|			И (ГрафикЗакрытия.ЭтапЗакрытия = ЗНАЧЕНИЕ(Перечисление.ТК_ЭтапыЗакрытия.Этап1))
	|			И (ГрафикЗакрытия.Ссылка.Организация = &Организация)
	|			И (ГрафикЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	|			И (&ОтборПериодЗакрытия)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ОграничениеОтбораКонтрагентовИДоговоров КАК ООКД
	|		ПО (ООКД.ДоговорКонтрагента = РТУ.Договор)
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПериодыДоговора КАК ПД
	// 17.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|		ПО (ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода <= ПД.ДатаОкончанияПериода)
	|			И (ПД.ДатаНачалаПериода <= ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода)
	// 17.11.2022 *** Gradum *** ЛеушинДК (конец)
	|			И (ПД.РасчетныйПериод = ДанныеРПА.РасчетныйПериод)
	|			И (ПД.Договор = РТУ.Договор)
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|ГДЕ
	|	ГПУ.Организация = &Организация
	|	И ООКД.ДоговорКонтрагента ЕСТЬ NULL
	|	И ЕСТЬNULL(&Договор, РТУ.Договор) = РТУ.Договор
	|	И &ОтборПериодЗакрытия
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТК_ПериодыЗакрытия.Организация,
	|	ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода,
	|	ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода,
	|	ВТ_ПериодыДоговора.РасчетныйПериод,
	|	ТК_ПериодыЗакрытия.Ссылка,
	|	ВТ_ПериодыДоговора.Договор,
	|	ГрафикЗакрытия.ДатаНачалаЭтапа > &ТекущаяДата,
	// 24.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-366
	|	ВТ_ПериодыДоговора.ДатаНачалаПериода КАК ДатаНачалаПериодаДоговора,
	// 24.11.2022 *** Gradum *** ЛеушинДК (конец)
	|	NULL,
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|	ИСТИНА	
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|ИЗ
	|	ВТ_ПериодыДоговора КАК ВТ_ПериодыДоговора
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_ПериодыЗакрытия.СписокОрганизаций КАК ТК_ПериодыЗакрытия
	// 17.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|		ПО ВТ_ПериодыДоговора.ДатаНачалаПериода <= ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода
	|			И (ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода <= ВТ_ПериодыДоговора.ДатаОкончанияПериода)
	// 17.11.2022 *** Gradum *** ЛеушинДК (конец)
	|			И (ТК_ПериодыЗакрытия.Ссылка.РасчетныйПериод = ВТ_ПериодыДоговора.РасчетныйПериод)
	|			И (ТК_ПериодыЗакрытия.Организация = ВТ_ПериодыДоговора.Организация)
	|			И (ТК_ПериодыЗакрытия.Ссылка.ДатаНачалаПериода <= &ПрогнознаяДата)
	|			И (ТК_ПериодыЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|			И (ТК_ПериодыЗакрытия.Ссылка.ДатаОкончанияПериода >= ВТ_ПериодыДоговора.МинимальноДопустимаяДатаОкончанияПериода)
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_НастройкаГрафикаЗакрытияРасчетногоПериодаНаКалендарныйГод.ГрафикЗакрытия КАК ГрафикЗакрытия
	|		ПО (ТК_ПериодыЗакрытия.Ссылка = ГрафикЗакрытия.ПериодЗакрытия)
	|			И (ГрафикЗакрытия.ЭтапЗакрытия = ЗНАЧЕНИЕ(Перечисление.ТК_ЭтапыЗакрытия.Этап1))
	|			И (ГрафикЗакрытия.Ссылка.Организация = &Организация)
	|			И (ГрафикЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	|			И (&ОтборПериодЗакрытия)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Договор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Организация КАК Организация,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ДатаНачалаПериода КАК ДатаНачалаПериода,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ДатаОкончанияПериода КАК ДатаОкончанияПериода,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.РасчетныйПериод КАК РасчетныйПериод,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ПериодЗакрытия КАК ПериодЗакрытия,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Договор КАК Договор,
	// 24.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-366
	|	МИНИМУМ(ВТ_ОрганизацияДоговорыПериоды_Пред.ДатаНачалаПериодаДоговора) КАК ДатаНачалаПериодаДоговора,
	// 24.11.2022 *** Gradum *** ЛеушинДК (конец)
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ЭтоПрогнозныйПериод КАК ЭтоПрогнозныйПериод,
	|	МАКСИМУМ(ВТ_ОрганизацияДоговорыПериоды_Пред.Документ) КАК Документ,
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|	МАКСИМУМ(ВТ_ОрганизацияДоговорыПериоды_Пред.ВерныйПериод) КАК ВерныйПериод
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|ПОМЕСТИТЬ ВТ_ОрганизацияДоговорыПериоды
	|ИЗ
	|	ВТ_ОрганизацияДоговорыПериоды_Пред КАК ВТ_ОрганизацияДоговорыПериоды_Пред
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Организация,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ДатаНачалаПериода,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ДатаОкончанияПериода,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.РасчетныйПериод,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ПериодЗакрытия,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Договор,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.ЭтоПрогнозныйПериод
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Организация,
	|	ВТ_ОрганизацияДоговорыПериоды_Пред.Договор
	|;
	|//Семен + Новые Временные таблицы. Собираем данные в ВТ заранее до соединений в ВТ_ИсходныеДанныеАктирования_Пред
 	|
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |	ОДП.Организация КАК Организация,
    |	ОДП.Договор КАК Договор,  
    |	ОДП.Документ,
    |	ОДП.ПериодЗакрытия КАК ПериодЗакрытия,
    |	ОДП.ЭтоПрогнозныйПериод КАК ЭтоПрогнозныйПериод,
    |	ОДП.ДатаНачалаПериода,
    |	ОДП.ДатаОкончанияПериода, 
    |	ОДП.ДатаНачалаПериодаДоговора,
    |	NULL КАК ДатаАктированияВедомости,
    |	ОДП.ВерныйПериод,
    |	ЗК.Ссылка КАК ЗаказКлиента
    |ПОМЕСТИТЬ ВТ_ИсходныеДанныеАктирования_СЗаказом_Пред
    |ИЗ
    |	ВТ_ОрганизацияДоговорыПериоды КАК ОДП
    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ДоговораЗаказов КАК ЗК
    |		ПО (ЗК.Договор = ОДП.Договор)
    |СГРУППИРОВАТЬ ПО
    |	ОДП.Организация,
    |	ОДП.Договор,
    |	ОДП.Документ,
    |	ЗК.Ссылка,
    |	ОДП.ПериодЗакрытия,
    |	ОДП.ДатаНачалаПериода,
    |	ОДП.ДатаОкончанияПериода,
    |	ОДП.ДатаНачалаПериодаДоговора,
    |	ОДП.ВерныйПериод,
    |	ОДП.ЭтоПрогнозныйПериод
    |ИНДЕКСИРОВАТЬ ПО
    |	Договор,
    |	ЗаказКлиента
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |Выбрать 
    |	ОДП.Договор,
    |	ТК_Билл.Ссылка КАК Ссылка,
    |	ТК_Билл.Release КАК Release,
    |	ТК_Билл.ЗаказКлиента КАК ЗаказКлиента,
    |	ТК_Билл.ДатаОказанияУслуги КАК ДатаОказанияУслуги,
    |	ТК_Билл.ДокументОснование КАК УДФ,
    |	ТК_Билл.Контейнер,
    |	ТК_Билл.Вагон
    |Поместить ВТ_Билл
    |ИЗ Документ.ТК_Билл КАК ТК_Билл 
    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ИсходныеДанныеАктирования_СЗаказом_Пред как ОДП
    |		ПО ТК_Билл.Release = ОДП.ЗаказКлиента 
    |			И (ТК_Билл.Проведен)
    |			И (ТК_Билл.ВидДокументаБилл <> ЗНАЧЕНИЕ(Перечисление.ТК_ВидыДокументовБилл.План))
    |			И (ТК_Билл.ИсточникБилл <> ЗНАЧЕНИЕ(Перечисление.ТК_ИсточникиБилла.ИРС))
    |			И ЕСТЬNULL(&Договор, ОДП.Договор) = ОДП.Договор
    |Сгруппировать по
    |	ОДП.Договор,
    |	ТК_Билл.Ссылка,
    |	ТК_Билл.Release,  
    |	ТК_Билл.ДатаОказанияУслуги,
    |	ТК_Билл.ДокументОснование,
    |	ТК_Билл.ЗаказКлиента,
    |	ТК_Билл.Контейнер,
    |	ТК_Билл.Вагон
    |Индексировать по
    |	Release,
    |	Ссылка,  
    |	Контейнер,
    |	Вагон  
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |	ФА1.Билл КАК Билл
    |ПОМЕСТИТЬ ВТ_ФА1
    |ИЗ
    |	РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА1
    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Билл КАК ВТ_Билл
    |		ПО ФА1.Билл = ВТ_Билл.Ссылка
    |			И (ФА1.Сторнирован)
    |			И (ФА1.КоррБилл <> ЗНАЧЕНИЕ(Документ.ТК_Билл.ПустаяСсылка))
    |
    |ИНДЕКСИРОВАТЬ ПО
    |	ФА1.Билл
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |	ФА2.КоррУДФ КАК КоррУДФ
    |ПОМЕСТИТЬ ВТ_ФА2
    |ИЗ
    |	РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА2
    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Билл КАК ВТ_Билл
    |		ПО ФА2.КоррУДФ = ВТ_Билл.УДФ
    |			И (ВТ_Билл.УДФ <> ЗНАЧЕНИЕ(Документ.ТК_ОтражениеФактическихУслуг.ПустаяСсылка))
    |			И (ФА2.Сторнирован)
    |
    |ИНДЕКСИРОВАТЬ ПО
    |	ФА2.КоррУДФ
    |;
    |
    |////////////////////////////////////////////////////////////////////////////////
    |ВЫБРАТЬ
    |	ФА3.КоррБилл КАК КоррБилл
    |ПОМЕСТИТЬ ВТ_ФА3
    |ИЗ
    |	РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА3
    |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Билл КАК ВТ_Билл
    |		ПО ФА3.КоррБилл = ВТ_Билл.Ссылка
    |			И (ФА3.Сторнирован)
    |
    |ИНДЕКСИРОВАТЬ ПО
    |	ФА3.КоррБилл
 	|//Семен - 
    |;   
    |
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОДП.Организация КАК Организация,
	|	МАКСИМУМ(ЗК.Ссылка) КАК ЗаказКлиента,
	|	ТК_Билл.Ссылка КАК Билл,
	|//Семен + 
	|//	МАКСИМУМ(ТК_Билл.ДокументОснование) КАК УДФ,
	|	МАКСИМУМ(ТК_Билл.УДФ) КАК УДФ,
	|//Семен - 
	|	ОДП.Договор КАК Договор,
	|	ОДП.ПериодЗакрытия КАК ПериодЗакрытия,
	|	ОДП.ЭтоПрогнозныйПериод КАК ЭтоПрогнозныйПериод,
	|	NULL КАК ДатаАктированияВедомости,
	|	ЕСТЬNULL(МАКСИМУМ(ТК_Билл.ЗаказКлиента = ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)), ЛОЖЬ) КАК ЭтоДопЗаказ
	|ПОМЕСТИТЬ ВТ_ИсходныеДанныеАктирования_Пред
	|ИЗ
 	|//Семен + 
	|//	ВТ_ОрганизацияДоговорыПериоды КАК ОДП
	|//		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ЗК
 	|//		ПО (ЗК.Договор = ОДП.Договор)
	|//			И (ЗК.Организация = ОДП.Организация)
	|	ВТ_ИсходныеДанныеАктирования_СЗаказом_Пред КАК ОДП
	|   	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_ДоговораЗаказов КАК ЗК
	|   	ПО ОДП.ЗаказКлиента = ЗК.Ссылка
	|   	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_ТранспортныеРешения КАК ТР
	|   	ПО (ЗК.ТК_БазовоеТранспортноеРешение = ТР.Ссылка)
	|//Семен - 
	|//Семен + 
	|//		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ТК_Билл КАК ТК_Билл
	|   	ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Билл КАК ТК_Билл
	|//Семен - 
	|		ПО (ЗК.Ссылка = ТК_Билл.Release)
	|//Семен + 
	|//			И (ТК_Билл.Проведен)
	|//			И (ТК_Билл.ВидДокументаБилл <> ЗНАЧЕНИЕ(Перечисление.ТК_ВидыДокументовБилл.План))
	|//			И (ТК_Билл.ИсточникБилл <> ЗНАЧЕНИЕ(Перечисление.ТК_ИсточникиБилла.ИРС))
	|//Семен - 
	|			И (ТК_Билл.ДатаОказанияУслуги МЕЖДУ ОДП.ДатаНачалаПериода И ОДП.ДатаОкончанияПериода)
	// 24.11.2022 *** Gradum *** ЛеушинДК (начало) https://youtrack50.trcont.ru/issue/RKS-366
	|			И ТК_Билл.ДатаОказанияУслуги >= ОДП.ДатаНачалаПериодаДоговора
	// 24.11.2022 *** Gradum *** ЛеушинДК (конец)
	// 10.11.2022 *** Gradum *** КучинаНГ (начало) https://youtrack50.trcont.ru/issue/RKS-314
	|		    И (ОДП.ВерныйПериод = ИСТИНА)
	// 10.11.2022 *** Gradum *** КучинаНГ (конец)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ВыполнениеКругорейсов КАК ТК_ВыполнениеКругорейсов
	|		ПО ОДП.Договор = ТК_ВыполнениеКругорейсов.Договор
	|			И (ЗК.ТК_МаршрутКругорейса = ТК_ВыполнениеКругорейсов.МаршрутКругорейса)
	|			И (ЗК.Ссылка = ТК_ВыполнениеКругорейсов.ЗаказДоходный)
	|			И (ВЫБОР
	|//Семен + Необязательно, т.к. БД сама преобразует, но двойные точки в запросе не очень нравятся
	|//				КОГДА ЗК.ТК_БазовоеТранспортноеРешение.ТипОтправки = &ТипОтправкиКонтейнерная
	|				КОГДА ТР.ТипОтправки = &ТипОтправкиКонтейнерная
	|//Семен - 
	|					ТОГДА ТК_Билл.Контейнер = ТК_ВыполнениеКругорейсов.ВагонКонтейнер
	|				ИНАЧЕ ТК_Билл.Вагон = ТК_ВыполнениеКругорейсов.ВагонКонтейнер
	|			КОНЕЦ)
	|//Семен + 
	|//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА1
	|//		ПО (ФА1.Билл = ТК_Билл.Ссылка)
	|//			И (ФА1.Сторнирован = ИСТИНА)
	|//			И (ФА1.КоррБилл <> ЗНАЧЕНИЕ(Документ.ТК_Билл.ПустаяСсылка))
	|//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА2
	|//		ПО (ФА2.КоррУДФ = ТК_Билл.ДокументОснование)
	|//			И (ТК_Билл.ДокументОснование <> ЗНАЧЕНИЕ(Документ.ТК_ОтражениеФактическихУслуг.ПустаяСсылка))
	|//			И (ФА2.Сторнирован = ИСТИНА)
	|//		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_ФактКСторнированиюПоАктам КАК ФА3
	|//		ПО (ФА3.КоррБилл = ТК_Билл.Ссылка)
	|//			И (ФА3.Сторнирован = ИСТИНА)
	|	    ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ФА1 КАК ФА1
	|	    ПО (ФА1.Билл = ТК_Билл.Ссылка)
	|	    ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ФА2 КАК ФА2
	|	    ПО (ФА2.КоррУДФ = ТК_Билл.УДФ)
	|	    ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ФА3 КАК ФА3
	|	    ПО (ФА3.КоррБилл = ТК_Билл.Ссылка)
	|//Семен - 
	|ГДЕ
	|	ОДП.Организация = &Организация
	|	И ФА1.Билл ЕСТЬ NULL
	|//Семен + 
	|//	И ФА2.Билл ЕСТЬ NULL
	|//	И ФА3.Билл ЕСТЬ NULL
	|   И ФА2.КоррУДФ ЕСТЬ NULL
	|   И ФА3.КоррБилл ЕСТЬ NULL   
	|//Семен - 
	|	И ЕСТЬNULL(&Договор, ОДП.Договор) = ОДП.Договор
	|	И &ОтборЗаказКлиента
	|	И ВЫБОР
	|			КОГДА ЗК.ТК_Кругорейс
	|				ТОГДА ЗК.ТК_ДоходныйПолурейс
	|						И ЕСТЬNULL(ТК_ВыполнениеКругорейсов.ЗаказРасходый, ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка)
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ
	|
	|СГРУППИРОВАТЬ ПО
	|	ОДП.Организация,
	|	ТК_Билл.Ссылка,
	|	ОДП.Договор,
	|	ОДП.ПериодЗакрытия,
	|	ОДП.ЭтоПрогнозныйПериод
	|
	|ИМЕЮЩИЕ
	|	(МАКСИМУМ(ОДП.Документ) ЕСТЬ НЕ NULL 
	|		ИЛИ ТК_Билл.Ссылка ЕСТЬ НЕ NULL )
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ТК_ВедомостиКАктированию.Организация,
	|	ТК_ВедомостиКАктированию.Билл.Release,
	|	ТК_ВедомостиКАктированию.Билл,
	|	ТК_ВедомостиКАктированию.Билл.ДокументОснование,
	|	ТК_ВедомостиКАктированию.Договор,
	|	ТК_ВедомостиКАктированию.ПериодЗакрытия,
	|	ГрафикЗакрытия.ДатаНачалаЭтапа > &ТекущаяДата,
	|	МИНИМУМ(ДПБ.Период),
	|	ИСТИНА
	|ИЗ
	|	РегистрСведений.ТК_ВедомостиКАктированию КАК ТК_ВедомостиКАктированию
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ЗК
	|		ПО (ЗК.Ссылка = ТК_ВедомостиКАктированию.Билл.Release)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_ПериодыЗакрытия КАК ТК_ПериодыЗакрытия
	|		ПО (ТК_ПериодыЗакрытия.Ссылка = ТК_ВедомостиКАктированию.ПериодЗакрытия)
	|			И (ТК_ПериодыЗакрытия.ДатаНачалаПериода <= &ПрогнознаяДата)
	|			И (ТК_ПериодыЗакрытия.ПометкаУдаления = ЛОЖЬ)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ТК_НастройкаГрафикаЗакрытияРасчетногоПериодаНаКалендарныйГод.ГрафикЗакрытия КАК ГрафикЗакрытия
	|		ПО (ТК_ПериодыЗакрытия.Ссылка = ГрафикЗакрытия.ПериодЗакрытия)
	|			И (ГрафикЗакрытия.ЭтапЗакрытия = ЗНАЧЕНИЕ(Перечисление.ТК_ЭтапыЗакрытия.Этап1))
	|			И (ГрафикЗакрытия.Ссылка.Организация = &Организация)
	|			И (ГрафикЗакрытия.Ссылка.ПометкаУдаления = ЛОЖЬ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТК_РТУ_ДанныеПоБиллам КАК ДПБ
	|		ПО (ДПБ.Билл = ТК_ВедомостиКАктированию.Билл)
	|ГДЕ
	|	ТК_ВедомостиКАктированию.Организация = &Организация
	|	И ТК_ВедомостиКАктированию.Билл.ДокументОснование.ИсточникФормирования В (ЗНАЧЕНИЕ(Перечисление.ТК_ИсточникФормированияОтражениеФактУслуг.Ведомость), ЗНАЧЕНИЕ(Перечисление.ТК_ИсточникФормированияОтражениеФактУслуг.ДопРасходы))
	|	И ЕСТЬNULL(&Договор, ТК_ВедомостиКАктированию.Договор) = ТК_ВедомостиКАктированию.Договор
	|	И &ОтборПериодЗакрытия
	|	И &ОтборЗаказКлиента
	|
	|СГРУППИРОВАТЬ ПО
	|	ТК_ВедомостиКАктированию.ПериодЗакрытия,
	|	ГрафикЗакрытия.ДатаНачалаЭтапа > &ТекущаяДата,
	|	ТК_ВедомостиКАктированию.Билл,
	|	ТК_ВедомостиКАктированию.Организация,
	|	ТК_ВедомостиКАктированию.Договор,
	|	ТК_ВедомостиКАктированию.Билл.Release,
	|	ТК_ВедомостиКАктированию.Билл.ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИДА.Организация КАК Организация,
	|	ИДА.ЗаказКлиента КАК ЗаказКлиента,
	|	ИДА.Билл КАК Билл,
	|	ИДА.УДФ КАК УДФ,
	|	ИДА.Договор КАК Договор,
	|	ИДА.ПериодЗакрытия КАК ПериодЗакрытия,
	|	ИДА.ЭтоПрогнозныйПериод КАК ЭтоПрогнозныйПериод,
	|	МАКСИМУМ(ИДА.ДатаАктированияВедомости) КАК ДатаАктированияВедомости,
	|	ИДА.ЭтоДопЗаказ КАК ЭтоДопЗаказ
	|ПОМЕСТИТЬ ВТ_ИсходныеДанныеАктирования
	|ИЗ
	|	ВТ_ИсходныеДанныеАктирования_Пред КАК ИДА
	|
	|СГРУППИРОВАТЬ ПО
	|	ИДА.Организация,
	|	ИДА.ЗаказКлиента,
	|	ИДА.Билл,
	|	ИДА.УДФ,
	|	ИДА.Договор,
	|	ИДА.ПериодЗакрытия,
	|	ИДА.ЭтоПрогнозныйПериод,
	|	ИДА.ЭтоДопЗаказ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Договор,
	|	ПериодЗакрытия
	|;
	|//Семен + 
	|
    |//////////////////////////////////////////////////////////////////////////////////
    |Уничтожить ВТ_ДоговораЗаказов
    |;
    |
    |//////////////////////////////////////////////////////////////////////////////////
    |УНИЧТОЖИТЬ ВТ_Билл
    |;
    |
    |//////////////////////////////////////////////////////////////////////////////////
    |УНИЧТОЖИТЬ ВТ_ИсходныеДанныеАктирования_СЗаказом_Пред
    |;
 	|//Семен - 
    |
    |//////////////////////////////////////////////////////////////////////////////////
    |УНИЧТОЖИТЬ ВТ_ИсходныеДанныеАктирования_Пред
    |;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЕСТЬNULL(КОЛИЧЕСТВО(*), 0) КАК КоличествоДанных
	|ИЗ
	|	ВТ_ИсходныеДанныеАктирования КАК ВТ_ИсходныеДанныеАктирования";
	
	Запрос.УстановитьПараметр("Договор", ПолучитьЗначениеПараметра(ДанныеКонтекста, "Договор", NULL));

	Если ПараметрКонтекстаЗаполнен(ДанныеКонтекста, "ПериодЗакрытия") Тогда
		Если ТипЗнч(ДанныеКонтекста.ПериодЗакрытия) = Тип("Массив") Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПериодЗакрытия", "ТК_ПериодыЗакрытия.Ссылка В (&ПериодЗакрытия)");
		Иначе 
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборПериодЗакрытия", "ТК_ПериодыЗакрытия.Ссылка = ЕСТЬNULL(&ПериодЗакрытия, ТК_ПериодыЗакрытия.Ссылка)");
		КонецЕсли;
		Запрос.УстановитьПараметр("ПериодЗакрытия", ДанныеКонтекста.ПериодЗакрытия);
	Иначе
		Запрос.УстановитьПараметр("ОтборПериодЗакрытия", Истина);
	КонецЕсли;
	
	Если ПараметрКонтекстаЗаполнен(ДанныеКонтекста, "ЗаказКлиента") Тогда
		Если ТипЗнч(ДанныеКонтекста.ЗаказКлиента) = Тип("Массив") Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборЗаказКлиента", "ЗК.Ссылка В (&ЗаказКлиента)");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборЗаказКлиента", "ЗК.Ссылка = &ЗаказКлиента");
		КонецЕсли;
		Запрос.УстановитьПараметр("ЗаказКлиента", ДанныеКонтекста.ЗаказКлиента);
	Иначе
		Запрос.УстановитьПараметр("ОтборЗаказКлиента", Истина);
	КонецЕсли;
	
	ЗначениеГлубиныПрогноза = ТК_ОбщегоНазначенияСервер.ПредопределенныйЭлемент("АктированиеГлубинаПрогноза", "Значение");
	Если НЕ ЗначениеЗаполнено(ЗначениеГлубиныПрогноза) Тогда
		ЗначениеГлубиныПрогноза = 30;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ТекущаяДата", НачалоДня(ТекущаяДата));
	Запрос.УстановитьПараметр("ПрогнознаяДата", НачалоДня(ТекущаяДата) + ЗначениеГлубиныПрогноза * 86400);
	Запрос.УстановитьПараметр("ТипОтправкиКонтейнерная", ИсходныеДанные.ТипОтправкиКонтейнерная);
	
	ЭтоРучнойЗапуск = НЕ ДанныеКонтекста.Свойство("ЭтоРучнойЗапуск") ИЛИ ДанныеКонтекста.ЭтоРучнойЗапуск;
	Запрос.УстановитьПараметр("ЭтоРучнойЗапуск", ЭтоРучнойЗапуск);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ИсходныеДанные.КоличествоДанных = Выборка.КоличествоДанных;
	КонецЕсли;

	Возврат ИсходныеДанные;
	
КонецФункции

```